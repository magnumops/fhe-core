# Architectural Decision Records (ADR) - Phase 3

## ADR-001: Синтезируемая Арифметика (Barrett Reduction)
*   **Дата:** Day 1 (Phase 3)
*   **Контекст:** Оригинальные модули `mod_mult` использовали операторы `%` и `/`, непригодные для синтеза в железо (ASIC/FPGA).
*   **Решение:** Внедрить алгоритм редукции Барретта.
*   **Детали:** Используется предвычисленная константа $\mu = \lfloor 2^{64} / Q \rfloor$. Умножение заменяется на серию сдвигов и вычитаний.
*   **Статус:** Accepted & Implemented.

## ADR-002: Выделенный Vector ALU
*   **Дата:** Day 2 (Phase 3)
*   **Контекст:** `ntt_arith_unit` был слишком специализирован под Butterfly-операции. Требовалась поддержка общих векторных операций (Add, Sub, Mult).
*   **Решение:** Выделить `vec_alu.v` как независимый комбинаторный модуль.
*   **Интерфейс:** Opcode (3 bit), OpA, OpB -> Result.
*   **Статус:** Accepted & Implemented.

## ADR-003: Динамические RNS Параметры
*   **Дата:** Day 3 (Phase 3)
*   **Контекст:** Эмулятор был жестко привязан к одному модулю Q (захардкоженные константы). RNS требует поддержки множества Q.
*   **Решение:** Удалить `localparam` из Verilog. Пробросить `input [63:0] q, mu, n_inv` через всю иерархию от Top-Level до листьев (`mod_mult`).
*   **Статус:** Accepted & Implemented.

## ADR-004: Command Processor и ISA
*   **Дата:** Day 4 (Phase 3)
*   **Контекст:** Управление эмулятором через прямые сигналы (`start`, `mode`) из C++ не масштабируется и не отражает реальную работу ускорителя.
*   **Решение:** Внедрить архитектуру "Поток Команд".
    *   Создан модуль `command_processor.v`.
    *   Определена 64-битная ISA (Opcode 8b + Payload 56b).
    *   Связь C++ -> RTL через `CommandQueue` и DPI.
*   **Статус:** Accepted & Implemented.

## ADR-005: Многобанковая Память (Multi-Bank Memory)
*   **Дата:** Day 5 (Phase 3)
*   **Контекст:** Stateless-режим (загрузка-вычисление-выгрузка) неэффективен. Требуется хранение промежуточных результатов.
*   **Решение:**
    *   Внедрить внутреннюю память `mem [0:3][0:N-1]` (4 слота).
    *   Добавить команды `LOAD` (Host->Slot) и `STORE` (Slot->Host).
    *   Операции `NTT` теперь адресуют конкретный слот.
*   **Статус:** Accepted & Implemented.
