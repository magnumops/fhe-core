# AI CONTEXT: LOGOS FHE ACCELERATOR EMULATOR

## 1. Суть Проекта
Аппаратно-программный эмулятор FHE-ускорителя (схема BFV) на базе Verilator (RTL) и Python (SDK).
Цель: Прототипирование двухъядерной архитектуры (Dual Core ASIC) для гомоморфного шифрования.

## 2. Текущий Статус (Phase 6 Completed)
*   **Версия:** v6.0 (Dual Core RNS).
*   **Архитектура:**
    *   **Dual Core:** Два независимых ядра (`ntt_engine #0`, `#1`) с общей памятью.
    *   **Memory Arbiter:** Blocking Round-Robin (честное распределение шины, защита от голодания).
    *   **Compute:** Реализован полный цикл BFV (NTT/INTT, Vector Add/Mult).
    *   **RNS:** Динамическая смена модуля через `OPC_CONFIG` (загрузка структуры q, mu, n_inv).
*   **Достижение:** Успешный тест **"Diamond Loop Dual"**: Параллельная загрузка -> Параллельный NTT -> Обмен данными через RAM -> Векторное умножение -> INTT -> Выгрузка.

## 3. Технический Стек & "Красные Линии" (CRITICAL)
### RTL (SystemVerilog)
*   **Command Latching:** Модуль `ntt_engine` **обязан** защелкивать входные параметры (`opcode`, `addr`) в состоянии IDLE. Использование прямых проводов в FSM вызывает гонки при смене команд.
*   **DMA Write:** Используется режим "Fire-and-Forget" (отключен `valid` ack в DPI-обертке) для Burst-записи. Адрес должен обновляться с Lookahead (`idx + 1`).
*   **Arbiter:** Только **Round-Robin**. Fixed Priority вызывает Deadlock/Starvation второго ядра.

### Driver (C++ / Verilator)
*   **Pipeline Hold Time:** Драйвер (`push_command`) обязан держать шину данных стабильной минимум **1 такт** после сброса `valid`, чтобы RTL успел защелкнуть команду.
*   **Linker Hell Fix:** В `dpi_impl.cpp` реализован "Hybrid Bridge", экспортирующий символы как с префиксом `dpi_` (для Verilog), так и `py_` (для Legacy Python).
*   **Timeouts:** Операции DMA (особенно Twiddles) занимают >30k тактов. Таймауты драйвера должны быть >100k.

### SDK (Python)
*   **LogosDriver:** Высокоуровневая обертка. Прямая манипуляция битами команд не рекомендуется.
*   **Memory Map:** Вектора разнесены по адресам `0x10000` (A), `0x20000` (B), `0x80000` (Twiddles) во избежание наложений.

## 4. Словарь Терминов
*   **Twiddles:** Поворотные множители. Загружаются через `OPC_LOAD_W`.
*   **Strict DMA:** Режим DMA "Запрос-Ответ" (медленный, надежный).
*   **Burst DMA:** Режим "Поток" (быстрый, требует точных таймингов). Сейчас работает Burst Write.
*   **Sapphire Loop:** Тест полного цикла на одном ядре.
*   **Diamond Loop Dual:** Тест полного цикла BFV с участием обоих ядер и обменом данными.

## 5. Известные Ограничения (Phase 7 TODO)
*   DMA Read работает в Pipelined режиме, но без очередей (FIFO) в Арбитре, что ограничивает пропускную способность.
*   Математическая точность (Bit-Exactness) относительно Microsoft SEAL еще не подтверждена на больших данных (использовались Dummy Twiddles).
