# Реестр Отвергнутых Гипотез и Ошибок (POSTMORTEM)

## Сессия: Фаза 1 (Integration Skeleton)
### Эпизод: Подключение Verilator к CMake в Docker

| ID | Гипотеза / Проблема | Предпринятое Действие | Результат | Анализ Провала (Root Cause) |
| :--- | :--- | :--- | :--- | :--- |
| PM-001 | `find_package(Verilator)` автоматически найдет пути в Ubuntu 22.04. | Использован стандартный `find_package`. | Ошибка CMake: переменные путей остались пустыми. | В пакете `verilator` для Ubuntu 22.04 отсутствуют корректные `.cmake` конфиги для автопоиска. |
| PM-002 | Verilator найдет исходники `.v`, если запустить его из папки `build`. | `COMMAND verilator ... src/rtl/counter.v` | Ошибка Verilator: `Cannot find file`. | Verilator (как и многие CLI утилиты) чувствителен к CWD. При запуске из `build` относительный путь `src/` неверен. Требуется абсолютный путь `${CMAKE_SOURCE_DIR}`. |
| PM-003 | Достаточно добавить основные `.cpp` файлы Verilator в `add_executable`. | Добавлены `Vcounter.cpp` и `Vcounter__Syms.cpp`. | Linker Error: `undefined reference to Vcounter::Vcounter`. | Линковщику не хватило файла `Vcounter__Slow.cpp`, где Verilator прячет конструкторы. |
| PM-004 | Если добавить все файлы в `add_executable`, CMake сам поймет, что их надо сгенерировать. | Добавлен `Vcounter__Slow.cpp` в цель сборки, но не в `OUTPUT` команды генерации. | CMake Error: `Cannot find source file`. | CMake проверяет наличие исходников *до* сборки. Если файл генерируемый, он ОБЯЗАН быть в списке `OUTPUT` той команды, которая его создает. |


## Успешное завершение Фазы 1
**Статус:** Скелет готов.
**Достижение:** Реализован класс `CounterSim` с методами `step()` и `reset()`. Python-тест прошел валидацию. Риски интеграции языков и инструментов устранены.

## Успешное завершение Дня 5
**Статус:** Mmap Spike пройден.
**Достижение:** Успешно аллоцирован 1 ТБ виртуальной памяти. Тест записи в начало, середину и конец файла прошел успешно.

## Успешное завершение Дня 6
**Статус:** DPI Bridge функционирует.
**Инциденты:**
1. `ModuleNotFoundError`: Забыли добавить путь к build. Исправлено через `sys.path`.
2. `Verilog read: 0x0`: Попытка записи в память до инициализации симулятора. Исправлено изменением порядка вызовов в тесте.
**Достижение:** Реализован сквозной доступ к данным: Python -> C++ (Mmap) -> Verilog (DPI).

## Успешное завершение Фазы 2
**Статус:** Память и DPI готовы.
**Достижение:** Реализована эмуляция 1 ТБ памяти через mmap. Реализован пакетный (Burst) режим передачи данных в Verilog.
**Ключевой урок:** Типы данных на границе языков (Verilog/C++) критичны. `reg` != `uint64_t`.

## Успешное завершение Дня 8
**Статус:** Интеграция SEAL (BFV Scheme) работает.
**Инциденты:**
1. Синтаксическая ошибка C++ (забытый инклюд).
2. Ошибка импорта Python (неверный порядок строк).
**Достижение:** Эмулятор теперь умеет выполнять реальное гомоморфное сложение.

## Успешное завершение Дня 10 (ФИНАЛ)
**Статус:** "Золотая Петля" работает.
**Инциденты:**
1. **Синтаксис C++:** Ошибки с `#` комментариями и областью видимости PyBind.
2. **Крипто-конфигурация:** `plain_modulus=1024` был слишком мал для числа 1337. Увеличили до 65537.
3. **Hardware Buffer Underrun:** Буфер в Verilog (4 КБ) был меньше размера шифртекста (88 КБ). Данные обрезались, расшифровка падала. Исправлено увеличением буфера до 128 КБ.
**Достижение:** Полный цикл данных (Python -> FHE -> RAM -> Verilog -> RAM -> FHE -> Python) верифицирован.

## Сессия: Фаза 2 (NTT Arithmetic Units)
### Эпизод: День 2 - Сборка Модулей Арифметики

| ID | Гипотеза / Проблема | Предпринятое Действие | Результат | Анализ Провала (Root Cause) |
| :--- | :--- | :--- | :--- | :--- |
| PM-P2-001 | Сгенерированные Verilator хедеры (`Vmodel.h`) автоматически видны компилятору C++ внутри CMake build folder. | Использован стандартный `pybind11_add_module` без добавления build-директории в include. | Build Error: `fatal error: Vcopy_engine.h: No such file`. | CMake не добавляет `CMAKE_CURRENT_BINARY_DIR` в пути поиска хедеров автоматически. Компилятор не знал, где лежат сгенерированные файлы. |
| PM-P2-002 | Verilog позволяет неявное расширение типов (авто-кастинг 64->65 бит). | Написан код `wire [64:0] s = a + b` (где a,b 64 бита). | Build Error (Lint): `Operator ASSIGNW expects 65 bits`. | Verilator в строгом режиме требует явного приведения типов. Нельзя складывать 64-битные числа и класть в 65 бит без явного паддинга `{1'b0, a}`. |
| PM-P2-003 | Файл `verilated_dpi.cpp` нужен только модулям, использующим Open Arrays. | Исключен `verilated_dpi.cpp` из цели `ntt_tester`. | Linker Error: `undefined symbol: svGetArrElemPtr1`. | DPI-символы часто являются глобальными или тянутся транзитивно. Если хоть один модуль в проекте (даже соседний) использует DPI Open Arrays, линковщик требует наличия реализации. |

## Сессия: Фаза 2 (NTT Arithmetic Units)
### Эпизод: День 2 - Сборка Модулей Арифметики

| ID | Гипотеза / Проблема | Предпринятое Действие | Результат | Анализ Провала (Root Cause) |
| :--- | :--- | :--- | :--- | :--- |
| PM-P2-001 | Сгенерированные Verilator хедеры (`Vmodel.h`) автоматически видны компилятору C++ внутри CMake build folder. | Использован стандартный `pybind11_add_module` без добавления build-директории в include. | Build Error: `fatal error: Vcopy_engine.h: No such file`. | CMake не добавляет `CMAKE_CURRENT_BINARY_DIR` в пути поиска хедеров автоматически. Компилятор не знал, где лежат сгенерированные файлы. |
| PM-P2-002 | Verilog позволяет неявное расширение типов (авто-кастинг 64->65 бит). | Написан код `wire [64:0] s = a + b` (где a,b 64 бита). | Build Error (Lint): `Operator ASSIGNW expects 65 bits`. | Verilator в строгом режиме требует явного приведения типов. Нельзя складывать 64-битные числа и класть в 65 бит без явного паддинга `{1'b0, a}`. |
| PM-P2-003 | Файл `verilated_dpi.cpp` нужен только модулям, использующим Open Arrays. | Исключен `verilated_dpi.cpp` из цели `ntt_tester`. | Linker Error: `undefined symbol: svGetArrElemPtr1`. | DPI-символы часто являются глобальными или тянутся транзитивно. Если хоть один модуль в проекте (даже соседний) использует DPI Open Arrays, линковщик требует наличия реализации. |

## Сессия: Фаза 2 (NTT Control Logic)
### Эпизод: День 5 - Разработка AGU (Address Generation Unit)

| ID | Гипотеза / Проблема | Предпринятое Действие | Результат | Анализ Провала (Root Cause) |
| :--- | :--- | :--- | :--- | :--- |
| PM-P2-004 | Ubuntu 22.04 содержит современный Verilator, поддерживающий `VerilatedContext`. | Использован код C++ обертки с `new Vntt_control{contextp}`. | Build Error: `VerilatedContext does not name a type`. | Репозитории Ubuntu содержат Verilator v4.038 (или старее), где Modern API еще не внедрен. Необходимо использовать Legacy API (`new Vmodel`). |
| PM-P2-005 | Для счетчиков цикла NTT размера N=8 достаточно 3-битных регистров (`reg [2:0]`). | Реализована логика `if (k + m < N)`. | Logic Error: Infinite Loop. | Переполнение (Integer Overflow). При `m=4` операция `m << 1` дает 8, что в 3 битах превращается в 0. Условие выхода из цикла никогда не выполняется. Требуется N_LOG+1 бит. |
| PM-P2-006 | Расширение внутренних регистров до 4 бит решит проблему, выходы можно оставить 3-битными. | `output reg [2:0] addr; ... addr <= k + j;` (где k, j - 4 бита). | Build Error (Strict Lint): `WIDTH mismatch`. | Verilator запрещает неявное усечение. Требуется явная выборка битов: `addr <= sum[2:0]`. |
| PM-P2-007 | Сигнал `valid` можно сбрасывать в блоке перехода к `DONE`. | `if (finished) begin state <= DONE; valid <= 0; end` | Test Failure: Потерян последний такт данных. | В Verilog присваивание `valid <= 0` в ветке `else` "перебивает" присваивание `valid <= 1` в начале блока. На последнем рабочем такте данные были верны, но флаг валидности был сброшен преждевременно. |
| PM-P2-008 | Hardware DIT NTT выдает неверный результат по сравнению с Naive Golden Model. | Загружены линейные данные `0..7`. | Test Fail. | Алгоритм Cooley-Tukey DIT требует Bit-Reversed входа. Кроме того, HW реализует Cyclic NTT, а Golden Model — Negacyclic. |

## Сессия: Фаза 2 (DPI Integration)
### Эпизод: День 7 - Интеграция Памяти

| ID | Гипотеза / Проблема | Предпринятое Действие | Результат | Анализ Провала (Root Cause) |
| :--- | :--- | :--- | :--- | :--- |
| PM-P2-009 | Разделение C++ кода на файлы (`.h` / `.cpp`). | Добавлен `#include "dpi_impl.h"`, но файл не создан. | Build Error. | Нарушение атомарности: код ссылался на несуществующий файл. |
| PM-P2-010 | Использование стандартных типов в хедере. | `size_t` без инклюдов. | Build Error. | Отсутствие `<cstddef>`. |
| PM-P2-011 | Использование старого Dockerfile для новой фазы. | Запуск `test_day10_final.py`. | Runtime Error. | Dockerfile не был обновлен под изменение API и архитектуры проекта. |
| PM-P2-012 | Pybind11 конвертация списков. | Вызов метода с Python list. | TypeError. | Забыт `<pybind11/stl.h>`. |
| PM-P2-013 | Совместимость Verilog `reg` и DPI `bit`. | Объявлен `reg mem` для приема данных из C++. | Silent Failure (Zero Data). | Фундаментальная несовместимость типов памяти при использовании Open Arrays. DPI `svGetArrElemPtr` ведет себя по-разному для 2-state и 4-state типов. Требуется использовать `bit`. |

## Сессия: Фаза 2 (INTT)
### Эпизод: День 9 - Обратное Преобразование

| ID | Гипотеза / Проблема | Предпринятое Действие | Результат | Анализ Провала (Root Cause) |
| :--- | :--- | :--- | :--- | :--- |
| PM-P2-014 | Генератор конфига `gen_twiddles_intt.py` найдет `ntt_config_4k` в PYTHONPATH по умолчанию. | Запуск скрипта без `sys.path.append`. | Runtime Error & Data Corruption. | Скрипт упал, не сгенерировал N_INV. `sed` вставил пустое значение в Verilog -> Syntax Error. Исправлено добавлением `os.getcwd()` в sys.path и проверкой переменных в shell-скрипте. |

# Session: Phase 3 (RNS & Architecture Upgrade)

## Episode: Day 3 - Dynamic Params
| ID | Гипотеза / Проблема | Результат | Root Cause |
| :--- | :--- | :--- | :--- |
| **PM-P3-01** | Обновление RTL для `mu`, но не `q`. | Self-Correction. | Логическая ошибка: Барретт требует и `mu`, и `q`. |
| **PM-P3-02** | Обновление конфига `ntt_config_4k.py`. | `AttributeError: no attribute 'N_LOG'` | **Context Blindness / Stale Cache.** 1. Команда выполнялась с неверным путем (префикс `VM/` внутри папки `VM`). 2. `__pycache__` внутри Docker не обновлялся при `COPY`. |

## Episode: Day 4 - Command Processor
| ID | Гипотеза / Проблема | Результат | Root Cause |
| :--- | :--- | :--- | :--- |
| **PM-P3-03** | Сборка Docker после смены API C++. | `AttributeError: no attribute 'run_ntt'` | **API Breaking Change.** Тест `test_day10_platinum.py` использовал старый метод, который был удален из C++. |
| **PM-P3-04** | Исправление теста. | `AttributeError` (повтор). | **Context Blindness.** Исправление записывалось в несуществующую вложенную папку `VM/tests/...` вместо `tests/...`. |
| **PM-P3-05** | Запуск DPI функций. | `stack smashing detected` | **ABI Mismatch.** В C++ функции `dpi_read_burst` были объявлены как принимающие `svBitVecVal*`, а Verilator передавал `svOpenArrayHandle`. Память корраптилась при доступе. |

## Episode: Day 5 - Multi-Bank Memory
| ID | Гипотеза / Проблема | Результат | Root Cause |
| :--- | :--- | :--- | :--- |
| **PM-P3-06** | Git Commit. | `pathspec ... did not match`. | **Navigation Error.** Запуск git из корня с путями `src/...` (которые валидны только внутри `VM/`). |
| **PM-P3-07** | RTL Compilation. | `Warning-WIDTH` (3 bits vs 2 bits). | **Type Mismatch.** `current_slot` был `reg [2:0]`, а массив `mem` имел размер 4 (2 бита). Verilator Strict Mode запрещает неявное усечение. |
| **PM-P3-08** | C++ Compilation. | `error: 'OPC_LOAD' was not declared`. | **Stale Header.** Файл `isa_spec.h` не обновился из-за ошибки путей в предыдущем шаге. |
| **PM-P3-09** | Linking. | `undefined symbol ..._eval`. | **Verilator Split.** Увеличение памяти привело к тому, что Verilator разбил код на несколько файлов, которые CMake не знал. |
| **PM-P3-10** | Runtime. | `Logos Core Timeout`. | **Simulation Freeze.** Эмулятор застревает. Причина выясняется (предположительно отсутствие `ready` сигнала или deadlock). |
| **PM-P3-11** | Instrumentation (Debug). | `syntax error, unexpected always`. | **Verilog Syntax.** Попытка вложить `always` блок внутрь другого `always` через `sed`. |
| **PM-P3-12** | Linker (Debug). | `undefined symbol: sc_time_stamp`. | **Missing Hook.** Использование `$time` в Verilog требует реализации `double sc_time_stamp()` в C++. |

## Фаза 5: Дни 6-8 (Dual Core & Arbitration)
**Инцидент 1:** Runtime Error: Logos Core Timeout (Day 6).
**Причина:** Некорректный сброс в C++ драйвере. Мы устанавливали `rst=1`, но не подавали тактовый сигнал (`clk`). Синхронная логика Verilog не видела сброса.
**Решение:** Внедрен метод `tick()` в конструкторе `LogosSim`, обеспечивающий прохождение тактов во время сброса.

**Инцидент 2:** Linker Error: Multiple definition (Day 6).
**Причина:** Конфликт между заглушками (stubs) в `emulator_core.cpp` и реальной реализацией в `dpi_impl.cpp`.
**Решение:** Удаление заглушек из основного C++ файла при линковке полного проекта.

**Инцидент 3:** CMake Syntax Error (Day 7).
**Причина:** Использование `sed` для редактирования списков файлов сломало синтаксис `${VAR}`.
**Решение:** Полная перезапись `CMakeLists.txt` вместо патчинга.

## Инцидент Фазы 5 (Dual Core Deadlock)
**Симптом:** Тесты падали по тайм-ауту или показывали 0 операций.
**Причина 1 (Reset Issue):** В C++ драйвере сброс (`rst=1`) подавался без тактирования (`clk`). Синхронная логика Verilog не сбрасывалась.
**Решение 1:** Внедрен метод `tick()` во время сброса.
**Причина 2 (Missing Backpressure):** Диспетчер команд принимал задачи быстрее, чем ядра могли их обработать, перезаписывая их.
**Решение 2:** Внедрен сигнал `cmd_ready` и цикл ожидания (Handshake) в C++ драйвере.

## Успешное завершение Фазы 5
**Статус:** "Изумрудная Петля" пройдена.
**Достижение:** Параллельное исполнение задач на двух ядрах верифицировано.
**Решенные проблемы:**
*   Timeout (Reset issue).
*   Dropped Commands (Backpressure implementation).
*   Linker Errors (DPI Cleanup).
